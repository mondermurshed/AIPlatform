@using AIPlatform2.Shared.Services
@inject SettingsService SettingsService
@inject IFolderPickerService FolderPickerService

<FluentStack Orientation="Orientation.Vertical" VerticalGap="10">


        <FluentTextField Value="@_displayPath"
                         Placeholder="Select model folder..."
                     ReadOnly="true" Label="Your Main Model Folder" style="width: 100%;" />
                     



            
    <FluentLabel Style="margin-bottom: 0px">@_validationError</FluentLabel>
    <FluentButton Appearance="Appearance.Accent" @onclick="OnBrowseClicked">Browse</FluentButton>

</FluentStack>

@code {
    private string? _displayPath = null;
    private string? _validationError;

    private static readonly System.Text.RegularExpressions.Regex _allowedAsciiPathRegex =
        new(@"^[A-Za-z0-9\s_\-:\\/\.]+$", System.Text.RegularExpressions.RegexOptions.Compiled);

    protected override void OnInitialized()
    {
        // Load saved path
        _displayPath = SettingsService.GetModelRootPath();
       
    }

    private async Task OnBrowseClicked()
    {
        _validationError = null;

        try
        {
            if (FolderPickerService is null)
            {
                _validationError = "The Tools To Open The Folder Picker Dialog Is Not Available For This Platform.";
                StateHasChanged();
                return;
            }

            var picked = await FolderPickerService.PickFolderAsync();

            if (string.IsNullOrWhiteSpace(picked))
            {
                _validationError = "Nothing Was Changed.";
                StateHasChanged();
                return;
            }

            if (!Directory.Exists(picked))
            {
                _validationError = "Picked Folder Does Not Exist.";
                StateHasChanged();
                return;
            }

            // NEW: validate that the path contains only allowed English/ASCII characters
            if (!IsPathAllowedEnglish(picked))
            {
                _validationError = "Selected folder path contains non-English characters. Please choose a path that uses only English letters/numbers and standard punctuation.";
                StateHasChanged();
                return;
            }

            // show and auto-save — unchanged
            SettingsService.SetModelRootPath(picked);
            _displayPath = SettingsService.GetModelRootPath();
            _validationError = "The New Path Was Successfully Saved.";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _validationError = $"Error Opening Folder Picker: {ex.GetType().Name}: {ex.Message}";
            StateHasChanged();
        }
    }

    private bool IsPathAllowedEnglish(string path)
    {
        if (string.IsNullOrWhiteSpace(path))
            return false;

        // Check for ASCII only (rejects Arabic, Chinese, emojis, etc.)
        foreach (var ch in path)
        {
            if (ch > 127) return false;
        }

        // Check allowed characters only
        return _allowedAsciiPathRegex.IsMatch(path);
    }


}
