@using DTOs
@implements IDialogContentComponent<SettingsDTO>
@implements IDisposable
@inject SettingsService SettingsService

<FluentDesignTheme Mode="@Mode" OfficeColor="@OfficeColor" />

<FluentDialogHeader>
    <FluentStack VerticalAlignment="VerticalAlignment.Center" HorizontalAlignment="HorizontalAlignment.Center">
        <FluentIcon Value="@(new Icons.Regular.Size32.Settings())" />
        <FluentLabel>Quick Settings</FluentLabel>
    </FluentStack>
</FluentDialogHeader>

<FluentDialogBody>
    <FluentCard Height="180px" AreaRestricted="false">
        <FluentSelect style="margin-bottom:10px;" Label="Theme"
                      Width="250px"
                      Items="@(Enum.GetValues<DesignThemeModes>().Where(m => m != DesignThemeModes.System))"
                      @bind-SelectedOption="Mode" />

        <FluentSelect style="margin-bottom:15px;" Label="Color"
                      Items="@(Enum.GetValues<OfficeColor>())"
                      Height="200px"
                      Width="250px"
                      @bind-SelectedOption="OfficeColor" />

        <FluentButton style="margin-left:5px;" Appearance="Appearance.Accent" OnClick="PickRandomColor">Feeling lucky?</FluentButton>
    </FluentCard>

    <FluentCard AreaRestricted="true" Style="margin-top: 20px; max-height: 180px; overflow: auto;">
      
            <ModelPathPicker />

    </FluentCard>


  
</FluentDialogBody>

@code {
    [Parameter] public SettingsDTO Content { get; set; } = default!;

    // Backing fields
    private DesignThemeModes _mode;
    private OfficeColor _officeColor;

    // Exposed properties bound to the FluentDesignTheme.
    // Setters call SettingsService (no changes to SettingsService required).
    public DesignThemeModes Mode
    {
        get => _mode;
        set
        {
            if (_mode == value) return;
            _mode = value;
            // Persist change using existing SettingsService API
            SettingsService.SetThemeMode(_mode);
            StateHasChanged();
        }
    }

    public OfficeColor OfficeColor
    {
        get => _officeColor;
        set
        {
            if (_officeColor == value) return;
            _officeColor = value;
            // Persist change using existing SettingsService API
            SettingsService.SetThemeColor(_officeColor);
            StateHasChanged();
        }
    }

    // Debounce token for the random color button
    private CancellationTokenSource? _debounceCts;

    protected override void OnInitialized()
    {
        // Initialize from SettingsService (use its getters; no changes to SettingsService)
        _mode = SettingsService.GetThemeMode();
        _officeColor = SettingsService.GetThemeColor();
    }

    private async Task PickRandomColor()
    {
        _debounceCts?.Cancel();
        _debounceCts?.Dispose();

        _debounceCts = new CancellationTokenSource();
        var token = _debounceCts.Token;

        try
        {
            // small debounce
            await Task.Delay(200, token);

            var random = OfficeColorUtilities.GetRandom();
            OfficeColor = random; // setter will call SettingsService.SetThemeColor(random)
        }
        catch (OperationCanceledException) { /* expected on rapid clicks */ }
    }

    public void Dispose()
    {
        _debounceCts?.Cancel();
        _debounceCts?.Dispose();
        _debounceCts = null;
    }
}
